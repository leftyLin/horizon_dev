
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openstack_dashboard.openstack.common.policy &mdash; Horizon 2014.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2014.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Horizon 2014.1 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openstack_dashboard.openstack.common.policy</h1><div class="highlight"><pre>
<span class="c"># vim: tabstop=4 shiftwidth=4 softtabstop=4</span>

<span class="c"># Copyright (c) 2012 OpenStack Foundation.</span>
<span class="c"># All Rights Reserved.</span>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c">#    a copy of the License at</span>
<span class="c">#</span>
<span class="c">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">#    License for the specific language governing permissions and limitations</span>
<span class="c">#    under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Common Policy Engine Implementation</span>

<span class="sd">Policies can be expressed in one of two forms: A list of lists, or a</span>
<span class="sd">string written in the new policy language.</span>

<span class="sd">In the list-of-lists representation, each check inside the innermost</span>
<span class="sd">list is combined as with an &quot;and&quot; conjunction--for that check to pass,</span>
<span class="sd">all the specified checks must pass.  These innermost lists are then</span>
<span class="sd">combined as with an &quot;or&quot; conjunction.  This is the original way of</span>
<span class="sd">expressing policies, but there now exists a new way: the policy</span>
<span class="sd">language.</span>

<span class="sd">In the policy language, each check is specified the same way as in the</span>
<span class="sd">list-of-lists representation: a simple &quot;a:b&quot; pair that is matched to</span>
<span class="sd">the correct code to perform that check.  However, conjunction</span>
<span class="sd">operators are available, allowing for more expressiveness in crafting</span>
<span class="sd">policies.</span>

<span class="sd">As an example, take the following rule, expressed in the list-of-lists</span>
<span class="sd">representation::</span>

<span class="sd">    [[&quot;role:admin&quot;], [&quot;project_id:%(project_id)s&quot;, &quot;role:projectadmin&quot;]]</span>

<span class="sd">In the policy language, this becomes::</span>

<span class="sd">    role:admin or (project_id:%(project_id)s and role:projectadmin)</span>

<span class="sd">The policy language also has the &quot;not&quot; operator, allowing a richer</span>
<span class="sd">policy rule::</span>

<span class="sd">    project_id:%(project_id)s and not role:dunce</span>

<span class="sd">Finally, two special policy checks should be mentioned; the policy</span>
<span class="sd">check &quot;@&quot; will always accept an access, and the policy check &quot;!&quot; will</span>
<span class="sd">always reject an access.  (Note that if a rule is either the empty</span>
<span class="sd">list (&quot;[]&quot;) or the empty string, this is equivalent to the &quot;@&quot; policy</span>
<span class="sd">check.)  Of these, the &quot;!&quot; policy check is probably the most useful,</span>
<span class="sd">as it allows particular rules to be explicitly disabled.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="kn">from</span> <span class="nn">oslo.config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common</span> <span class="kn">import</span> <span class="n">fileutils</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common.gettextutils</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common</span> <span class="kn">import</span> <span class="n">jsonutils</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>

<span class="n">policy_opts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">StrOpt</span><span class="p">(</span><span class="s">&#39;policy_file&#39;</span><span class="p">,</span>
               <span class="n">default</span><span class="o">=</span><span class="s">&#39;policy.json&#39;</span><span class="p">,</span>
               <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;JSON file containing policy&#39;</span><span class="p">)),</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">StrOpt</span><span class="p">(</span><span class="s">&#39;policy_default_rule&#39;</span><span class="p">,</span>
               <span class="n">default</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span>
               <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Rule enforced when requested rule is not found&#39;</span><span class="p">)),</span>
<span class="p">]</span>

<span class="n">CONF</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span>
<span class="n">CONF</span><span class="o">.</span><span class="n">register_opts</span><span class="p">(</span><span class="n">policy_opts</span><span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">_checks</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="PolicyNotAuthorized"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.PolicyNotAuthorized">[docs]</a><span class="k">class</span> <span class="nc">PolicyNotAuthorized</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Policy doesn&#39;t allow </span><span class="si">%s</span><span class="s"> to be performed.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">rule</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PolicyNotAuthorized</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Rules"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Rules">[docs]</a><span class="k">class</span> <span class="nc">Rules</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A store for rules. Handles the default_rule setting directly.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Rules.load_json"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Rules.load_json">[docs]</a>    <span class="k">def</span> <span class="nf">load_json</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">default_rule</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow loading of JSON rule data.&quot;&quot;&quot;</span>

        <span class="c"># Suck in the JSON data and parse the rules</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">parse_rule</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                     <span class="n">jsonutils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">default_rule</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default_rule</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Rules store.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Rules</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">rules</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span> <span class="o">=</span> <span class="n">default_rule</span>

    <span class="k">def</span> <span class="nf">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements the default rule handling.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c"># If the default rule isn&#39;t actually defined, do something</span>
        <span class="c"># reasonably intelligent</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span><span class="p">,</span> <span class="n">BaseCheck</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dumps a string representation of the rules.&quot;&quot;&quot;</span>

        <span class="c"># Start by building the canonical strings for the rules</span>
        <span class="n">out_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c"># Use empty string for singleton TrueCheck instances</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">TrueCheck</span><span class="p">):</span>
                <span class="n">out_rules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_rules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c"># Dump a pretty-printed JSON representation</span>
        <span class="k">return</span> <span class="n">jsonutils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">out_rules</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Enforcer"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Enforcer">[docs]</a><span class="k">class</span> <span class="nc">Enforcer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Responsible for loading and enforcing rules.</span>

<span class="sd">    :param policy_file: Custom policy file to use, if none is</span>
<span class="sd">                        specified, `CONF.policy_file` will be</span>
<span class="sd">                        used.</span>
<span class="sd">    :param rules: Default dictionary / Rules to use. It will be</span>
<span class="sd">                  considered just in the first instantiation. If</span>
<span class="sd">                  `load_rules(True)`, `clear()` or `set_rules(True)`</span>
<span class="sd">                  is called this will be overwritten.</span>
<span class="sd">    :param default_rule: Default rule to use, CONF.default_rule will</span>
<span class="sd">                         be used if none is specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default_rule</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">Rules</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">default_rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span> <span class="o">=</span> <span class="n">default_rule</span> <span class="ow">or</span> <span class="n">CONF</span><span class="o">.</span><span class="n">policy_default_rule</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">policy_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_file</span> <span class="o">=</span> <span class="n">policy_file</span> <span class="ow">or</span> <span class="n">CONF</span><span class="o">.</span><span class="n">policy_file</span>

<div class="viewcode-block" id="Enforcer.set_rules"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Enforcer.set_rules">[docs]</a>    <span class="k">def</span> <span class="nf">set_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new Rules object based on the provided dict of rules.</span>

<span class="sd">        :param rules: New rules to use. It should be an instance of dict.</span>
<span class="sd">        :param overwrite: Whether to overwrite current rules or update them</span>
<span class="sd">                          with the new rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rules must be an instance of dict or Rules, &quot;</span>
                            <span class="s">&quot;got </span><span class="si">%s</span><span class="s"> instead&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">rules</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">Rules</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Enforcer.clear"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Enforcer.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears Enforcer rules, policy&#39;s cache and policy&#39;s path.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_rules</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_path</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Enforcer.load_rules"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Enforcer.load_rules">[docs]</a>    <span class="k">def</span> <span class="nf">load_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reload</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads policy_path&#39;s rules.</span>

<span class="sd">        Policy file is cached and will be reloaded if modified.</span>

<span class="sd">        :param force_reload: Whether to overwrite current rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_policy_path</span><span class="p">()</span>

        <span class="n">reloaded</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">fileutils</span><span class="o">.</span><span class="n">read_cached_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_path</span><span class="p">,</span>
                                                    <span class="n">force_reload</span><span class="o">=</span><span class="n">force_reload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reloaded</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">Rules</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_rule</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_rules</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rules successfully reloaded&quot;</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_get_policy_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Locate the policy json data file.</span>

<span class="sd">        :param policy_file: Custom policy file to locate.</span>

<span class="sd">        :returns: The policy path</span>

<span class="sd">        :raises: ConfigFilesNotFoundError if the file couldn&#39;t</span>
<span class="sd">                 be located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">policy_file</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">policy_file</span>

        <span class="k">raise</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ConfigFilesNotFoundError</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">CONF</span><span class="o">.</span><span class="n">policy_file</span><span class="p">)</span>

<div class="viewcode-block" id="Enforcer.enforce"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Enforcer.enforce">[docs]</a>    <span class="k">def</span> <span class="nf">enforce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">do_raise</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">exc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks authorization of a rule against the target and credentials.</span>

<span class="sd">        :param rule: A string or BaseCheck instance specifying the rule</span>
<span class="sd">                    to evaluate.</span>
<span class="sd">        :param target: As much information about the object being operated</span>
<span class="sd">                    on as possible, as a dictionary.</span>
<span class="sd">        :param creds: As much information about the user performing the</span>
<span class="sd">                    action as possible, as a dictionary.</span>
<span class="sd">        :param do_raise: Whether to raise an exception or not if check</span>
<span class="sd">                        fails.</span>
<span class="sd">        :param exc: Class of the exception to raise if the check fails.</span>
<span class="sd">                    Any remaining arguments passed to check() (both</span>
<span class="sd">                    positional and keyword arguments) will be passed to</span>
<span class="sd">                    the exception class. If not specified, PolicyNotAuthorized</span>
<span class="sd">                    will be used.</span>

<span class="sd">        :return: Returns False if the policy does not allow the action and</span>
<span class="sd">                exc is not provided; otherwise, returns a value that</span>
<span class="sd">                evaluates to True.  Note: for rules using the &quot;case&quot;</span>
<span class="sd">                expression, this True value will be the specified string</span>
<span class="sd">                from the expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># NOTE(flaper87): Not logging target or creds to avoid</span>
        <span class="c"># potential security issues.</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rule </span><span class="si">%s</span><span class="s"> will be now enforced&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">rule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_rules</span><span class="p">()</span>

        <span class="c"># Allow the rule to be a Check tree</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">BaseCheck</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="c"># No rules to reference means we&#39;re going to fail closed</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># Evaluate the rule</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">rule</span><span class="p">](</span><span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Rule [</span><span class="si">%s</span><span class="s">] doesn&#39;t exist&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">rule</span><span class="p">)</span>
                <span class="c"># If the rule doesn&#39;t exist, fail closed</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># If it is False, raise the exception if requested</span>
        <span class="k">if</span> <span class="n">do_raise</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">PolicyNotAuthorized</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

</div></div>
<div class="viewcode-block" id="BaseCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.BaseCheck">[docs]</a><span class="k">class</span> <span class="nc">BaseCheck</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for Check classes.&quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation of the Check tree rooted at this node.&quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Triggers if instance of the class is called.</span>

<span class="sd">        Performs the check. Returns False to reject the access or a</span>
<span class="sd">        true value (not necessary True) to accept the access.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span>

</div>
<div class="viewcode-block" id="FalseCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.FalseCheck">[docs]</a><span class="k">class</span> <span class="nc">FalseCheck</span><span class="p">(</span><span class="n">BaseCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A policy check that always returns False (disallow).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of this check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;!&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the policy.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="TrueCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.TrueCheck">[docs]</a><span class="k">class</span> <span class="nc">TrueCheck</span><span class="p">(</span><span class="n">BaseCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A policy check that always returns True (allow).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of this check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;@&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the policy.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="Check"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.Check">[docs]</a><span class="k">class</span> <span class="nc">Check</span><span class="p">(</span><span class="n">BaseCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class to allow for user-defined policy checks.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates Check instance.</span>

<span class="sd">        :param kind: The kind of the check, i.e., the field before the</span>
<span class="sd">                     &#39;:&#39;.</span>
<span class="sd">        :param match: The match of the check, i.e., the field after</span>
<span class="sd">                      the &#39;:&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of this check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="NotCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.NotCheck">[docs]</a><span class="k">class</span> <span class="nc">NotCheck</span><span class="p">(</span><span class="n">BaseCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the &quot;not&quot; logical operator.</span>

<span class="sd">    A policy check that inverts the result of another policy check.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the &#39;not&#39; check.</span>

<span class="sd">        :param rule: The rule to negate.  Must be a Check.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">=</span> <span class="n">rule</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of this check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;not </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the policy.</span>

<span class="sd">        Returns the logical inverse of the wrapped check.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AndCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.AndCheck">[docs]</a><span class="k">class</span> <span class="nc">AndCheck</span><span class="p">(</span><span class="n">BaseCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the &quot;and&quot; logical operator.</span>

<span class="sd">    A policy check that requires that a list of other checks all return True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the &#39;and&#39; check.</span>

<span class="sd">        :param rules: A list of rules that will be tested.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of this check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the policy.</span>

<span class="sd">        Requires that all rules accept in order to return True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rule</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="AndCheck.add_check"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.AndCheck.add_check">[docs]</a>    <span class="k">def</span> <span class="nf">add_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds rule to be tested.</span>

<span class="sd">        Allows addition of another rule to the list of rules that will</span>
<span class="sd">        be tested.  Returns the AndCheck object for convenience.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

</div></div>
<div class="viewcode-block" id="OrCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.OrCheck">[docs]</a><span class="k">class</span> <span class="nc">OrCheck</span><span class="p">(</span><span class="n">BaseCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the &quot;or&quot; operator.</span>

<span class="sd">    A policy check that requires that at least one of a list of other</span>
<span class="sd">    checks returns True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the &#39;or&#39; check.</span>

<span class="sd">        :param rules: A list of rules that will be tested.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string representation of this check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the policy.</span>

<span class="sd">        Requires that at least one rule accept in order to return True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rule</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>

<div class="viewcode-block" id="OrCheck.add_check"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.OrCheck.add_check">[docs]</a>    <span class="k">def</span> <span class="nf">add_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds rule to be tested.</span>

<span class="sd">        Allows addition of another rule to the list of rules that will</span>
<span class="sd">        be tested.  Returns the OrCheck object for convenience.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

</div></div>
<span class="k">def</span> <span class="nf">_parse_check</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a single base check rule into an appropriate Check object.&quot;&quot;&quot;</span>

    <span class="c"># Handle the special checks</span>
    <span class="k">if</span> <span class="n">rule</span> <span class="o">==</span> <span class="s">&#39;!&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FalseCheck</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TrueCheck</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Failed to understand rule </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">rule</span><span class="p">)</span>
        <span class="c"># If the rule is invalid, we&#39;ll fail closed</span>
        <span class="k">return</span> <span class="n">FalseCheck</span><span class="p">()</span>

    <span class="c"># Find what implements the check</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">_checks</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_checks</span><span class="p">[</span><span class="n">kind</span><span class="p">](</span><span class="n">kind</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">_checks</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_checks</span><span class="p">[</span><span class="bp">None</span><span class="p">](</span><span class="n">kind</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No handler for matches of kind </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FalseCheck</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_parse_list_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translates the old list-of-lists syntax into a tree of Check objects.</span>

<span class="sd">    Provided for backwards compatibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Empty rule defaults to True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rule</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TrueCheck</span><span class="p">()</span>

    <span class="c"># Outer list is joined by &quot;or&quot;; inner list by &quot;and&quot;</span>
    <span class="n">or_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">inner_rule</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
        <span class="c"># Elide empty inner lists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inner_rule</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># Handle bare strings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner_rule</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">inner_rule</span> <span class="o">=</span> <span class="p">[</span><span class="n">inner_rule</span><span class="p">]</span>

        <span class="c"># Parse the inner rules into Check objects</span>
        <span class="n">and_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_check</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">inner_rule</span><span class="p">]</span>

        <span class="c"># Append the appropriate check to the or_list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">and_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">or_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">and_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">or_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AndCheck</span><span class="p">(</span><span class="n">and_list</span><span class="p">))</span>

    <span class="c"># If we have only one check, omit the &quot;or&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">or_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FalseCheck</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">or_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">OrCheck</span><span class="p">(</span><span class="n">or_list</span><span class="p">)</span>


<span class="c"># Used for tokenizing the policy language</span>
<span class="n">_tokenize_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\s+&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_tokenize</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tokenizer for the policy language.</span>

<span class="sd">    Most of the single-character tokens are specified in the</span>
<span class="sd">    _tokenize_re; however, parentheses need to be handled specially,</span>
<span class="sd">    because they can appear inside a check string.  Thankfully, those</span>
<span class="sd">    parentheses that appear inside a check string can never occur at</span>
<span class="sd">    the very beginning or end (&quot;%(variable)s&quot; is the correct syntax).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">_tokenize_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
        <span class="c"># Skip empty tokens</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tok</span> <span class="ow">or</span> <span class="n">tok</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="c"># Handle leading parens on the token</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;(&#39;</span>

        <span class="c"># If it was only parentheses, continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clean</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">clean</span>

        <span class="c"># Handle trailing parens on the token</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">trail</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>

        <span class="c"># Yield the cleaned token</span>
        <span class="n">lowered</span> <span class="o">=</span> <span class="n">clean</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lowered</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;and&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;not&#39;</span><span class="p">):</span>
            <span class="c"># Special tokens</span>
            <span class="k">yield</span> <span class="n">lowered</span><span class="p">,</span> <span class="n">clean</span>
        <span class="k">elif</span> <span class="n">clean</span><span class="p">:</span>
            <span class="c"># Not a special token, but not composed solely of &#39;)&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">((</span><span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tok</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span>
                                  <span class="p">[(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)]):</span>
                <span class="c"># It&#39;s a quoted string</span>
                <span class="k">yield</span> <span class="s">&#39;string&#39;</span><span class="p">,</span> <span class="n">tok</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="n">_parse_check</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>

        <span class="c"># Yield the trailing parens</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trail</span><span class="p">):</span>
            <span class="k">yield</span> <span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="s">&#39;)&#39;</span>


<div class="viewcode-block" id="ParseStateMeta"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.ParseStateMeta">[docs]</a><span class="k">class</span> <span class="nc">ParseStateMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metaclass for the ParseState class.</span>

<span class="sd">    Facilitates identifying reduction methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the class.</span>

<span class="sd">        Injects the &#39;reducers&#39; list, a list of tuples matching token sequences</span>
<span class="sd">        to the names of the corresponding reduction methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">reducers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;reducers&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">reduction</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">reducers</span><span class="p">:</span>
                <span class="n">reducers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">reduction</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

        <span class="n">cls_dict</span><span class="p">[</span><span class="s">&#39;reducers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reducers</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ParseStateMeta</span><span class="p">,</span> <span class="n">mcs</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="reducer"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.reducer">[docs]</a><span class="k">def</span> <span class="nf">reducer</span><span class="p">(</span><span class="o">*</span><span class="n">tokens</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for reduction methods.</span>

<span class="sd">    Arguments are a sequence of tokens, in order, which should trigger running</span>
<span class="sd">    this reduction method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="c"># Make sure we have a list of reducer sequences</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;reducers&#39;</span><span class="p">):</span>
            <span class="n">func</span><span class="o">.</span><span class="n">reducers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Add the tokens to the list of reducer sequences</span>
        <span class="n">func</span><span class="o">.</span><span class="n">reducers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">decorator</span>

</div>
<div class="viewcode-block" id="ParseState"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.ParseState">[docs]</a><span class="k">class</span> <span class="nc">ParseState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement the core of parsing the policy language.</span>

<span class="sd">    Uses a greedy reduction algorithm to reduce a sequence of tokens into</span>
<span class="sd">    a single terminal, the value of which will be the root of the Check tree.</span>

<span class="sd">    Note: error reporting is rather lacking.  The best we can get with</span>
<span class="sd">    this parser formulation is an overall &quot;parse failed&quot; error.</span>
<span class="sd">    Fortunately, the policy language is simple enough that this</span>
<span class="sd">    shouldn&#39;t be that big a problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ParseStateMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the ParseState.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ParseState.reduce"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.ParseState.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a greedy reduction of the token stream.</span>

<span class="sd">        If a reducer method matches, it will be executed, then the</span>
<span class="sd">        reduce() method will be called recursively to search for any more</span>
<span class="sd">        possible reductions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">reduction</span><span class="p">,</span> <span class="n">methname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducers</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reduction</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">reduction</span><span class="p">):]</span> <span class="o">==</span> <span class="n">reduction</span><span class="p">):</span>
                <span class="c"># Get the reduction method</span>
                <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methname</span><span class="p">)</span>

                <span class="c"># Reduce the token stream</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">reduction</span><span class="p">):])</span>

                <span class="c"># Update the tokens and values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">reduction</span><span class="p">):]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">reduction</span><span class="p">):]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

                <span class="c"># Check for any more reductions</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ParseState.shift"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.ParseState.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds one more token to the state.  Calls reduce().&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c"># Do a greedy reduce...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="ParseState.result"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.ParseState.result">[docs]</a>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain the final result of the parse.</span>

<span class="sd">        Raises ValueError if the parse failed to reduce to a single result.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Could not parse rule&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;and_expr&#39;</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39;or_expr&#39;</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_wrap_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_p1</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">_p2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn parenthesized expressions into a &#39;check&#39; token.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="n">check</span><span class="p">)]</span>

    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="s">&#39;and&#39;</span><span class="p">,</span> <span class="s">&#39;check&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_make_and_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check1</span><span class="p">,</span> <span class="n">_and</span><span class="p">,</span> <span class="n">check2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an &#39;and_expr&#39;.</span>

<span class="sd">        Join two checks by the &#39;and&#39; operator.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;and_expr&#39;</span><span class="p">,</span> <span class="n">AndCheck</span><span class="p">([</span><span class="n">check1</span><span class="p">,</span> <span class="n">check2</span><span class="p">]))]</span>

    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;and_expr&#39;</span><span class="p">,</span> <span class="s">&#39;and&#39;</span><span class="p">,</span> <span class="s">&#39;check&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_extend_and_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">and_expr</span><span class="p">,</span> <span class="n">_and</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extend an &#39;and_expr&#39; by adding one more check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;and_expr&#39;</span><span class="p">,</span> <span class="n">and_expr</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="n">check</span><span class="p">))]</span>

    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;check&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_make_or_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check1</span><span class="p">,</span> <span class="n">_or</span><span class="p">,</span> <span class="n">check2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an &#39;or_expr&#39;.</span>

<span class="sd">        Join two checks by the &#39;or&#39; operator.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;or_expr&#39;</span><span class="p">,</span> <span class="n">OrCheck</span><span class="p">([</span><span class="n">check1</span><span class="p">,</span> <span class="n">check2</span><span class="p">]))]</span>

    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;or_expr&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;check&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_extend_or_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">or_expr</span><span class="p">,</span> <span class="n">_or</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extend an &#39;or_expr&#39; by adding one more check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;or_expr&#39;</span><span class="p">,</span> <span class="n">or_expr</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="n">check</span><span class="p">))]</span>

    <span class="nd">@reducer</span><span class="p">(</span><span class="s">&#39;not&#39;</span><span class="p">,</span> <span class="s">&#39;check&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_make_not_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_not</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invert the result of another check.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;check&#39;</span><span class="p">,</span> <span class="n">NotCheck</span><span class="p">(</span><span class="n">check</span><span class="p">))]</span>

</div>
<span class="k">def</span> <span class="nf">_parse_text_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses policy to the tree.</span>

<span class="sd">    Translates a policy written in the policy language into a tree of</span>
<span class="sd">    Check objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Empty rule means always accept</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rule</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TrueCheck</span><span class="p">()</span>

    <span class="c"># Parse the token stream</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tok</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_parse_tokenize</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">result</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># Couldn&#39;t parse the rule</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Failed to understand rule </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">rule</span><span class="p">)</span>

        <span class="c"># Fail closed</span>
        <span class="k">return</span> <span class="n">FalseCheck</span><span class="p">()</span>


<div class="viewcode-block" id="parse_rule"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.parse_rule">[docs]</a><span class="k">def</span> <span class="nf">parse_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a policy rule into a tree of Check objects.&quot;&quot;&quot;</span>

    <span class="c"># If the rule is a string, it&#39;s in the policy language</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_parse_text_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_parse_list_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="register"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.register">[docs]</a><span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a function or Check class as a policy check.</span>

<span class="sd">    :param name: Gives the name of the check type, e.g., &#39;rule&#39;,</span>
<span class="sd">                 &#39;role&#39;, etc.  If name is None, a default check type</span>
<span class="sd">                 will be registered.</span>
<span class="sd">    :param func: If given, provides the function or class to register.</span>
<span class="sd">                 If not given, returns a function taking one argument</span>
<span class="sd">                 to specify the function or class to register,</span>
<span class="sd">                 allowing use as a decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Perform the actual decoration by registering the function or</span>
    <span class="c"># class.  Returns the function or class for compliance with the</span>
    <span class="c"># decorator interface.</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">_checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="c"># If the function or class is given, do the registration</span>
    <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorator</span>

</div>
<span class="nd">@register</span><span class="p">(</span><span class="s">&quot;rule&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RuleCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.RuleCheck">[docs]</a><span class="k">class</span> <span class="nc">RuleCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively checks credentials based on the defined rules.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">enforcer</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">](</span><span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># We don&#39;t have any matching rule; fail closed</span>
            <span class="k">return</span> <span class="bp">False</span>

</div>
<span class="nd">@register</span><span class="p">(</span><span class="s">&quot;role&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RoleCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.RoleCheck">[docs]</a><span class="k">class</span> <span class="nc">RoleCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that there is a matching role in the cred dict.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">creds</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">]]</span>

</div>
<span class="nd">@register</span><span class="p">(</span><span class="s">&#39;http&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="HttpCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.HttpCheck">[docs]</a><span class="k">class</span> <span class="nc">HttpCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check http: rules by calling to a remote server.</span>

<span class="sd">        This example implementation simply verifies that the response</span>
<span class="sd">        is exactly &#39;True&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;http:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">)</span> <span class="o">%</span> <span class="n">target</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;target&#39;</span><span class="p">:</span> <span class="n">jsonutils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
                <span class="s">&#39;credentials&#39;</span><span class="p">:</span> <span class="n">jsonutils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">creds</span><span class="p">)}</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">post_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span>

</div>
<span class="nd">@register</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<div class="viewcode-block" id="GenericCheck"><a class="viewcode-back" href="../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.policy.html#openstack_dashboard.openstack.common.policy.GenericCheck">[docs]</a><span class="k">class</span> <span class="nc">GenericCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">creds</span><span class="p">,</span> <span class="n">enforcer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check an individual match.</span>

<span class="sd">        Matches look like:</span>

<span class="sd">            tenant:%(tenant_id)s</span>
<span class="sd">            role:compute:admin</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># TODO(termie): do dict inspection via dot syntax</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">%</span> <span class="n">target</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="n">creds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span> <span class="o">==</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">creds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">False</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Horizon 2014.1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, OpenStack Foundation.
      Last updated on Tue Mar 11 04:36:31 2014, commit 1b0106e.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>