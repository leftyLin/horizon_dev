
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openstack_dashboard.openstack.common.rpc.amqp &mdash; Horizon 2014.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '2014.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <link rel="top" title="Horizon 2014.1 documentation" href="../../../../../index.html" />
    <link rel="up" title="openstack_dashboard.openstack.common.rpc" href="../rpc.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openstack_dashboard.openstack.common.rpc.amqp</h1><div class="highlight"><pre>
<span class="c"># vim: tabstop=4 shiftwidth=4 softtabstop=4</span>

<span class="c"># Copyright 2010 United States Government as represented by the</span>
<span class="c"># Administrator of the National Aeronautics and Space Administration.</span>
<span class="c"># All Rights Reserved.</span>
<span class="c"># Copyright 2011 - 2012, Red Hat, Inc.</span>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c">#    a copy of the License at</span>
<span class="c">#</span>
<span class="c">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">#    License for the specific language governing permissions and limitations</span>
<span class="c">#    under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Shared code between AMQP based openstack.common.rpc implementations.</span>

<span class="sd">The code in this module is shared between the rpc implemenations based on AMQP.</span>
<span class="sd">Specifically, this includes impl_kombu and impl_qpid.  impl_carrot also uses</span>
<span class="sd">AMQP, but is deprecated and predates this code.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">eventlet</span> <span class="kn">import</span> <span class="n">greenpool</span>
<span class="kn">from</span> <span class="nn">eventlet</span> <span class="kn">import</span> <span class="n">pools</span>
<span class="kn">from</span> <span class="nn">eventlet</span> <span class="kn">import</span> <span class="n">queue</span>
<span class="kn">from</span> <span class="nn">eventlet</span> <span class="kn">import</span> <span class="n">semaphore</span>
<span class="c"># TODO(pekowsk): Remove import cfg and below comment in Havana.</span>
<span class="c"># This import should no longer be needed when the amqp_rpc_single_reply_queue</span>
<span class="c"># option is removed.</span>
<span class="kn">from</span> <span class="nn">oslo.config</span> <span class="kn">import</span> <span class="n">cfg</span>

<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common</span> <span class="kn">import</span> <span class="n">excutils</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common.gettextutils</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common</span> <span class="kn">import</span> <span class="n">local</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">openstack_dashboard.openstack.common.rpc</span> <span class="kn">import</span> <span class="n">common</span> <span class="k">as</span> <span class="n">rpc_common</span>


<span class="c"># TODO(pekowski): Remove this option in Havana.</span>
<span class="n">amqp_opts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">BoolOpt</span><span class="p">(</span><span class="s">&#39;amqp_rpc_single_reply_queue&#39;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s">&#39;Enable a fast single reply queue if using AMQP based &#39;</span>
                <span class="s">&#39;RPC like RabbitMQ or Qpid.&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">register_opts</span><span class="p">(</span><span class="n">amqp_opts</span><span class="p">)</span>

<span class="n">UNIQUE_ID</span> <span class="o">=</span> <span class="s">&#39;_unique_id&#39;</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Pool"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.Pool">[docs]</a><span class="k">class</span> <span class="nc">Pool</span><span class="p">(</span><span class="n">pools</span><span class="o">.</span><span class="n">Pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that implements a Pool of Connections.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">connection_cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_cls</span> <span class="o">=</span> <span class="n">connection_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&quot;max_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">rpc_conn_pool_size</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&quot;order_as_stack&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply_proxy</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># TODO(comstud): Timeout connections not used in a while</span>
<div class="viewcode-block" id="Pool.create"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.Pool.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Pool creating new connection&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Pool.empty"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.Pool.empty">[docs]</a>    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># Force a new connection pool to be created.</span>
        <span class="c"># Note that this was added due to failing unit test cases. The issue</span>
        <span class="c"># is the above &quot;while loop&quot; gets all the cached connections from the</span>
        <span class="c"># pool and closes them, but never returns them to the pool, a pool</span>
        <span class="c"># leak. The unit tests hang waiting for an item to be returned to the</span>
        <span class="c"># pool. The unit tests get here via the teatDown() method. In the run</span>
        <span class="c"># time code, it gets here via cleanup() and only appears in service.py</span>
        <span class="c"># just before doing a sys.exit(), so cleanup() only happens once and</span>
        <span class="c"># the leakage is not a problem.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_cls</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="bp">None</span>

</div></div>
<span class="n">_pool_create_sem</span> <span class="o">=</span> <span class="n">semaphore</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">()</span>


<div class="viewcode-block" id="get_connection_pool"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.get_connection_pool">[docs]</a><span class="k">def</span> <span class="nf">get_connection_pool</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_cls</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_pool_create_sem</span><span class="p">:</span>
        <span class="c"># Make sure only one thread tries to create the connection pool.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connection_cls</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
            <span class="n">connection_cls</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_cls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connection_cls</span><span class="o">.</span><span class="n">pool</span>

</div>
<div class="viewcode-block" id="ConnectionContext"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ConnectionContext">[docs]</a><span class="k">class</span> <span class="nc">ConnectionContext</span><span class="p">(</span><span class="n">rpc_common</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class that is actually returned to the caller of</span>
<span class="sd">    create_connection().  This is essentially a wrapper around</span>
<span class="sd">    Connection that supports &#39;with&#39;.  It can also return a new</span>
<span class="sd">    Connection, or one from a pool.  The function will also catch</span>
<span class="sd">    when an instance of this class is to be deleted.  With that</span>
<span class="sd">    we can return Connections to the pool on exceptions and so</span>
<span class="sd">    forth without making the caller be responsible for catching</span>
<span class="sd">    them.  If possible the function makes sure to return a</span>
<span class="sd">    connection to the pool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">pooled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">server_params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new connection, or get one from the pool.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span> <span class="o">=</span> <span class="n">connection_pool</span>
        <span class="k">if</span> <span class="n">pooled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection_pool</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection_pool</span><span class="o">.</span><span class="n">connection_cls</span><span class="p">(</span>
                <span class="n">conf</span><span class="p">,</span>
                <span class="n">server_params</span><span class="o">=</span><span class="n">server_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pooled</span> <span class="o">=</span> <span class="n">pooled</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When with ConnectionContext() is used, return self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the connection came from a pool, clean it up and put it back.</span>
<span class="sd">        If it did not come from a pool, close it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooled</span><span class="p">:</span>
                <span class="c"># Reset the connection so it&#39;s ready for the next caller</span>
                <span class="c"># to grab from the pool</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End of &#39;with&#39; statement.  We&#39;re done here.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Caller is done with this connection.  Make sure we cleaned up.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">()</span>

<div class="viewcode-block" id="ConnectionContext.close"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ConnectionContext.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Caller is done with this connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ConnectionContext.create_consumer"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ConnectionContext.create_consumer">[docs]</a>    <span class="k">def</span> <span class="nf">create_consumer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">fanout</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">create_consumer</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">fanout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConnectionContext.create_worker"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ConnectionContext.create_worker">[docs]</a>    <span class="k">def</span> <span class="nf">create_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">pool_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">create_worker</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">pool_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConnectionContext.join_consumer_pool"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ConnectionContext.join_consumer_pool">[docs]</a>    <span class="k">def</span> <span class="nf">join_consumer_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">pool_name</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">join_consumer_pool</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
                                           <span class="n">pool_name</span><span class="p">,</span>
                                           <span class="n">topic</span><span class="p">,</span>
                                           <span class="n">exchange_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConnectionContext.consume_in_thread"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ConnectionContext.consume_in_thread">[docs]</a>    <span class="k">def</span> <span class="nf">consume_in_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">consume_in_thread</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Proxy all other calls to the Connection instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">InvalidRPCConnectionReuse</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="ReplyProxy"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ReplyProxy">[docs]</a><span class="k">class</span> <span class="nc">ReplyProxy</span><span class="p">(</span><span class="n">ConnectionContext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Connection class for RPC replies / callbacks.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters_wrn_threshold</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span> <span class="o">=</span> <span class="s">&#39;reply_&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ReplyProxy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">pooled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_direct_consumer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consume_in_thread</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_data</span><span class="p">):</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_msg_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">waiter</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;no calling threads waiting for msg_id : </span><span class="si">%(msg_id)s</span><span class="s">&#39;</span>
                       <span class="s">&#39;, message : </span><span class="si">%(data)s</span><span class="s">&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s">&#39;msg_id&#39;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
                                                 <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="n">message_data</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">waiter</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message_data</span><span class="p">)</span>

<div class="viewcode-block" id="ReplyProxy.add_call_waiter"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ReplyProxy.add_call_waiter">[docs]</a>    <span class="k">def</span> <span class="nf">add_call_waiter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waiter</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters_wrn_threshold</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Number of call waiters is greater than warning &#39;</span>
                       <span class="s">&#39;threshold: </span><span class="si">%d</span><span class="s">. There could be a MulticallProxyWaiter &#39;</span>
                       <span class="s">&#39;leak.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters_wrn_threshold</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters_wrn_threshold</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiters</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">waiter</span>
</div>
<div class="viewcode-block" id="ReplyProxy.del_call_waiter"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ReplyProxy.del_call_waiter">[docs]</a>    <span class="k">def</span> <span class="nf">del_call_waiter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_call_waiters</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiters</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ReplyProxy.get_reply_q"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ReplyProxy.get_reply_q">[docs]</a>    <span class="k">def</span> <span class="nf">get_reply_q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span>

</div></div>
<div class="viewcode-block" id="msg_reply"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.msg_reply">[docs]</a><span class="k">def</span> <span class="nf">msg_reply</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">reply_q</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">failure</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ending</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">log_failure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a reply or an error on the channel signified by msg_id.</span>

<span class="sd">    Failure should be a sys.exc_info() tuple.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_remote_exception</span><span class="p">(</span><span class="n">failure</span><span class="p">,</span>
                                                            <span class="n">log_failure</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">reply</span><span class="p">,</span> <span class="s">&#39;failure&#39;</span><span class="p">:</span> <span class="n">failure</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">reply</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()),</span>
                   <span class="s">&#39;failure&#39;</span><span class="p">:</span> <span class="n">failure</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ending</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s">&#39;ending&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c"># If a reply_q exists, add the msg_id to the reply and pass the</span>
        <span class="c"># reply_q to direct_send() to use it as the response queue.</span>
        <span class="c"># Otherwise use the msg_id for backward compatibilty.</span>
        <span class="k">if</span> <span class="n">reply_q</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s">&#39;_msg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_id</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">direct_send</span><span class="p">(</span><span class="n">reply_q</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">direct_send</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="RpcContext"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.RpcContext">[docs]</a><span class="k">class</span> <span class="nc">RpcContext</span><span class="p">(</span><span class="n">rpc_common</span><span class="o">.</span><span class="n">CommonRpcContext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context that supports replying to a rpc.call.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;msg_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply_q</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;reply_q&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;conf&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RpcContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="RpcContext.deepcopy"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.RpcContext.deepcopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">values</span><span class="p">[</span><span class="s">&#39;conf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span>
        <span class="n">values</span><span class="p">[</span><span class="s">&#39;msg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_id</span>
        <span class="n">values</span><span class="p">[</span><span class="s">&#39;reply_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply_q</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RpcContext.reply"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.RpcContext.reply">[docs]</a>    <span class="k">def</span> <span class="nf">reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">failure</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ending</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">connection_pool</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log_failure</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_id</span><span class="p">:</span>
            <span class="n">msg_reply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply_q</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span>
                      <span class="n">reply</span><span class="p">,</span> <span class="n">failure</span><span class="p">,</span> <span class="n">ending</span><span class="p">,</span> <span class="n">log_failure</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ending</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg_id</span> <span class="o">=</span> <span class="bp">None</span>

</div></div>
<div class="viewcode-block" id="unpack_context"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.unpack_context">[docs]</a><span class="k">def</span> <span class="nf">unpack_context</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unpack context from msg.&quot;&quot;&quot;</span>
    <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c"># NOTE(vish): Some versions of python don&#39;t like unicode keys</span>
        <span class="c">#             in kwargs.</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_context_&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">context_dict</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">9</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;msg_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_msg_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;reply_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_reply_q&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;conf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">RpcContext</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">context_dict</span><span class="p">)</span>
    <span class="n">rpc_common</span><span class="o">.</span><span class="n">_safe_log</span><span class="p">(</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;unpacked context: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">ctx</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ctx</span>

</div>
<div class="viewcode-block" id="pack_context"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.pack_context">[docs]</a><span class="k">def</span> <span class="nf">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pack context into msg.</span>

<span class="sd">    Values for message keys need to be less than 255 chars, so we pull</span>
<span class="sd">    context out into a bunch of separate keys. If we want to support</span>
<span class="sd">    more arguments in rabbit messages, we may want to do the same</span>
<span class="sd">    for args at some point.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context_d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s">&#39;_context_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                      <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context_d</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">_MsgIdCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class checks any duplicate messages.&quot;&quot;&quot;</span>

    <span class="c"># NOTE: This value is considered can be a configuration item, but</span>
    <span class="c">#       it is not necessary to change its value in most cases,</span>
    <span class="c">#       so let this value as static for now.</span>
    <span class="n">DUP_MSG_CHECK_SIZE</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_msgids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">([],</span>
                                             <span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DUP_MSG_CHECK_SIZE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_duplicate_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;AMQP consumers may read same message twice when exceptions occur</span>
<span class="sd">           before ack is returned. This method prevents doing it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">UNIQUE_ID</span> <span class="ow">in</span> <span class="n">message_data</span><span class="p">:</span>
            <span class="n">msg_id</span> <span class="o">=</span> <span class="n">message_data</span><span class="p">[</span><span class="n">UNIQUE_ID</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_msgids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_msgids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">DuplicateMessageError</span><span class="p">(</span><span class="n">msg_id</span><span class="o">=</span><span class="n">msg_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add unique_id for checking duplicate messages.&quot;&quot;&quot;</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">UNIQUE_ID</span><span class="p">:</span> <span class="n">unique_id</span><span class="p">})</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;UNIQUE_ID is </span><span class="si">%s</span><span class="s">.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">unique_id</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_ThreadPoolWithWait</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for a delayed invocation manager used by</span>
<span class="sd">    the Connection class to start up green threads</span>
<span class="sd">    to handle incoming messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">greenpool</span><span class="o">.</span><span class="n">GreenPool</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">rpc_thread_pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span> <span class="o">=</span> <span class="n">connection_pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait for all callback threads to exit.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">waitall</span><span class="p">()</span>


<div class="viewcode-block" id="CallbackWrapper"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.CallbackWrapper">[docs]</a><span class="k">class</span> <span class="nc">CallbackWrapper</span><span class="p">(</span><span class="n">_ThreadPoolWithWait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a straight callback to allow it to be invoked in a green</span>
<span class="sd">    thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param conf: cfg.CONF instance</span>
<span class="sd">        :param callback: a callable (probably a function)</span>
<span class="sd">        :param connection_pool: connection pool as returned by</span>
<span class="sd">                                get_connection_pool()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CallbackWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span>
            <span class="n">connection_pool</span><span class="o">=</span><span class="n">connection_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">spawn_n</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="n">message_data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ProxyCallback"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.ProxyCallback">[docs]</a><span class="k">class</span> <span class="nc">ProxyCallback</span><span class="p">(</span><span class="n">_ThreadPoolWithWait</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls methods on a proxy object based on method and args.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProxyCallback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span>
            <span class="n">connection_pool</span><span class="o">=</span><span class="n">connection_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id_cache</span> <span class="o">=</span> <span class="n">_MsgIdCache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Consumer callback to call a method on a proxy object.</span>

<span class="sd">        Parses the message for validity and fires off a thread to call the</span>
<span class="sd">        proxy object method.</span>

<span class="sd">        Message data should be a dictionary with two keys:</span>
<span class="sd">            method: string representing the method to call</span>
<span class="sd">            args: dictionary of arg: value</span>

<span class="sd">        Example: {&#39;method&#39;: &#39;echo&#39;, &#39;args&#39;: {&#39;value&#39;: 42}}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># It is important to clear the context here, because at this point</span>
        <span class="c"># the previous context is stored in local.store.context</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">local</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="s">&#39;context&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">local</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">context</span>
        <span class="n">rpc_common</span><span class="o">.</span><span class="n">_safe_log</span><span class="p">(</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;received </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">message_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id_cache</span><span class="o">.</span><span class="n">check_duplicate_message</span><span class="p">(</span><span class="n">message_data</span><span class="p">)</span>
        <span class="n">ctxt</span> <span class="o">=</span> <span class="n">unpack_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">message_data</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;method&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">message_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;namespace&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;no method for message: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">message_data</span><span class="p">)</span>
            <span class="n">ctxt</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;No method for message: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">message_data</span><span class="p">,</span>
                       <span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">spawn_n</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_data</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span>
                          <span class="n">namespace</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a message in a new thread.</span>

<span class="sd">        If the proxy object we have has a dispatch method</span>
<span class="sd">        (see rpc.dispatcher.RpcDispatcher), pass it the version,</span>
<span class="sd">        method, and args and let it dispatch as appropriate.  If not, use</span>
<span class="sd">        the old behavior of magically calling the specified method on the</span>
<span class="sd">        proxy we have here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ctxt</span><span class="o">.</span><span class="n">update_store</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="c"># Check if the result was a generator</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgenerator</span><span class="p">(</span><span class="n">rval</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rval</span><span class="p">:</span>
                    <span class="n">ctxt</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctxt</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">)</span>
            <span class="c"># This final None tells multicall that it is done.</span>
            <span class="n">ctxt</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="n">ending</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Expected exception during message handling (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">)</span> <span class="o">%</span>
                      <span class="n">e</span><span class="o">.</span><span class="n">_exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ctxt</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">_exc_info</span><span class="p">,</span>
                       <span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">,</span>
                       <span class="n">log_failure</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c"># sys.exc_info() is deleted by LOG.exception().</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Exception during message handling&#39;</span><span class="p">),</span>
                      <span class="n">exc_info</span><span class="o">=</span><span class="n">exc_info</span><span class="p">)</span>
            <span class="n">ctxt</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">,</span> <span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MulticallProxyWaiter"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.MulticallProxyWaiter">[docs]</a><span class="k">class</span> <span class="nc">MulticallProxyWaiter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_id</span> <span class="o">=</span> <span class="n">msg_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">conf</span><span class="o">.</span><span class="n">rpc_response_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reply_proxy</span> <span class="o">=</span> <span class="n">connection_pool</span><span class="o">.</span><span class="n">reply_proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_got_ending</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataqueue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">LightQueue</span><span class="p">()</span>
        <span class="c"># Add this caller to the reply proxy&#39;s call_waiters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reply_proxy</span><span class="o">.</span><span class="n">add_call_waiter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id_cache</span> <span class="o">=</span> <span class="n">_MsgIdCache</span><span class="p">()</span>

<div class="viewcode-block" id="MulticallProxyWaiter.put"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.MulticallProxyWaiter.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MulticallProxyWaiter.done"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.MulticallProxyWaiter.done">[docs]</a>    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># Remove this caller from reply proxy&#39;s call_waiters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reply_proxy</span><span class="o">.</span><span class="n">del_call_waiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_msg_id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id_cache</span><span class="o">.</span><span class="n">check_duplicate_message</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;failure&#39;</span><span class="p">]:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;failure&#39;</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">deserialize_remote_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">,</span>
                                                             <span class="n">failure</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ending&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_got_ending</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a result until we get a reply with an &#39;ending&#39; flag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataqueue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">Timeout</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_got_ending</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">result</span>
            <span class="k">yield</span> <span class="n">result</span>


<span class="c">#TODO(pekowski): Remove MulticallWaiter() in Havana.</span></div>
<div class="viewcode-block" id="MulticallWaiter"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.MulticallWaiter">[docs]</a><span class="k">class</span> <span class="nc">MulticallWaiter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">iterconsume</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span> <span class="ow">or</span>
                                                <span class="n">conf</span><span class="o">.</span><span class="n">rpc_response_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_got_ending</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id_cache</span> <span class="o">=</span> <span class="n">_MsgIdCache</span><span class="p">()</span>

<div class="viewcode-block" id="MulticallWaiter.done"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.MulticallWaiter.done">[docs]</a>    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_done</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The consume() callback will call this.  Store the result.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_id_cache</span><span class="o">.</span><span class="n">check_duplicate_message</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;failure&#39;</span><span class="p">]:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;failure&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">deserialize_remote_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">,</span>
                                                                   <span class="n">failure</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ending&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_got_ending</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a result until we get a &#39;None&#39; response from consumer&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_got_ending</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">result</span>
            <span class="k">yield</span> <span class="n">result</span>

</div>
<div class="viewcode-block" id="create_connection"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.create_connection">[docs]</a><span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a connection.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">pooled</span><span class="o">=</span><span class="ow">not</span> <span class="n">new</span><span class="p">)</span>

</div>
<span class="n">_reply_proxy_create_sem</span> <span class="o">=</span> <span class="n">semaphore</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">()</span>


<div class="viewcode-block" id="multicall"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.multicall">[docs]</a><span class="k">def</span> <span class="nf">multicall</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a call that returns multiple times.&quot;&quot;&quot;</span>
    <span class="c"># TODO(pekowski): Remove all these comments in Havana.</span>
    <span class="c"># For amqp_rpc_single_reply_queue = False,</span>
    <span class="c"># Can&#39;t use &#39;with&#39; for multicall, as it returns an iterator</span>
    <span class="c"># that will continue to use the connection.  When it&#39;s done,</span>
    <span class="c"># connection.close() will get called which will put it back into</span>
    <span class="c"># the pool</span>
    <span class="c"># For amqp_rpc_single_reply_queue = True,</span>
    <span class="c"># The &#39;with&#39; statement is mandatory for closing the connection</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Making synchronous call on </span><span class="si">%s</span><span class="s"> ...&#39;</span><span class="p">),</span> <span class="n">topic</span><span class="p">)</span>
    <span class="n">msg_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;_msg_id&#39;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">})</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;MSG_ID is </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg_id</span><span class="p">))</span>
    <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c"># TODO(pekowski): Remove this flag and the code under the if clause</span>
    <span class="c">#                 in Havana.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">amqp_rpc_single_reply_queue</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span>
        <span class="n">wait_msg</span> <span class="o">=</span> <span class="n">MulticallWaiter</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">declare_direct_consumer</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="n">wait_msg</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">topic_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_reply_proxy_create_sem</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">connection_pool</span><span class="o">.</span><span class="n">reply_proxy</span><span class="p">:</span>
                <span class="n">connection_pool</span><span class="o">.</span><span class="n">reply_proxy</span> <span class="o">=</span> <span class="n">ReplyProxy</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;_reply_q&#39;</span><span class="p">:</span> <span class="n">connection_pool</span><span class="o">.</span><span class="n">reply_proxy</span><span class="o">.</span><span class="n">get_reply_q</span><span class="p">()})</span>
        <span class="n">wait_msg</span> <span class="o">=</span> <span class="n">MulticallProxyWaiter</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">topic_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wait_msg</span>

</div>
<div class="viewcode-block" id="call"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.call">[docs]</a><span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a message on a topic and wait for a response.&quot;&quot;&quot;</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">multicall</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span>
    <span class="c"># NOTE(vish): return the last result from the multicall</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">rv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="cast"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.cast">[docs]</a><span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a message on a topic without waiting for a response.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Making asynchronous cast on </span><span class="si">%s</span><span class="s">...&#39;</span><span class="p">),</span> <span class="n">topic</span><span class="p">)</span>
    <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">topic_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="fanout_cast"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.fanout_cast">[docs]</a><span class="k">def</span> <span class="nf">fanout_cast</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a message on a fanout exchange without waiting for a response.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Making asynchronous fanout cast...&#39;</span><span class="p">))</span>
    <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">fanout_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="cast_to_server"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.cast_to_server">[docs]</a><span class="k">def</span> <span class="nf">cast_to_server</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">server_params</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a message on a topic to a specific server.&quot;&quot;&quot;</span>
    <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">pooled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                           <span class="n">server_params</span><span class="o">=</span><span class="n">server_params</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">topic_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="fanout_cast_to_server"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.fanout_cast_to_server">[docs]</a><span class="k">def</span> <span class="nf">fanout_cast_to_server</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">server_params</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
                          <span class="n">connection_pool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a message on a fanout exchange to a specific server.&quot;&quot;&quot;</span>
    <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">pooled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                           <span class="n">server_params</span><span class="o">=</span><span class="n">server_params</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">fanout_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="notify"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.notify">[docs]</a><span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">,</span> <span class="n">envelope</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a notification event on a topic.&quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Sending </span><span class="si">%(event_type)s</span><span class="s"> on </span><span class="si">%(topic)s</span><span class="s">&#39;</span><span class="p">),</span>
              <span class="nb">dict</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;event_type&#39;</span><span class="p">),</span>
                   <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">))</span>
    <span class="n">_add_unique_id</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pack_context</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ConnectionContext</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">connection_pool</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">envelope</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">rpc_common</span><span class="o">.</span><span class="n">serialize_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">notify_send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cleanup"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.cleanup">[docs]</a><span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">connection_pool</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">connection_pool</span><span class="p">:</span>
        <span class="n">connection_pool</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="get_control_exchange"><a class="viewcode-back" href="../../../../../sourcecode/openstack_dashboard/openstack_dashboard.openstack.common.rpc.amqp.html#openstack_dashboard.openstack.common.rpc.amqp.get_control_exchange">[docs]</a><span class="k">def</span> <span class="nf">get_control_exchange</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">control_exchange</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">Horizon 2014.1 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../rpc.html" accesskey="U">openstack_dashboard.openstack.common.rpc</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, OpenStack Foundation.
      Last updated on Tue Mar 11 04:36:31 2014, commit 1b0106e.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>